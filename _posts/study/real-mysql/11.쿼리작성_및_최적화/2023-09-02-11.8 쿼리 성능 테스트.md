---
title: 11.8 쿼리 성능 테스트

categories:
- real-mysql

tags:
- study
- database

toc: true
toc_sticky: true
toc_label: Contents
---

## 11.8.1 쿼리의 성능에 영향을 미치는 요소
작성한 쿼리를 실행해 보고 성능을 판단할 때 가장 큰 변수는 MySQL 서버가 가지고 있는 여러 종류의 버퍼나 캐시일 것이다.

### 11.8.1.1 운영체제의 캐시
MySQL 서버는 운영체제의 파일 시스템 관련 기능(시스템 콜)을 이용해 데이터 파일을 읽어온다.
→ 일반적으로 대부분의 운영체제는 한 번 읽은 데이터는 운영체제가 관리하는 별도의 캐시 영역에 보관했다가 데이터가 요청되면 디스크를 읽지 않고 MySQL 서버로 반환한다.
→ InnoDB 스토리지 엔진은 파일 시스템의 캐시나 버퍼를 거치지 않는 Direct I/O를 사용하므로 운영체제 캐시가 큰 영향을 미치지 않는다.
→ MyISAM 스토리지 엔진은 캐시에 대한 의존도가 높기 때문에 성능 차이가 큰 편이다.

운영체제가 관리하는 캐시나 버퍼는 공용 공간이기 때문에 응용 프로그램이 종료된다고 해도 여전히 남아있을 수 있다.
→ 운영체제가 가지고 있는 캐시나 버퍼가 전혀 없는 상태에서 쿼리의 성능을 테스트하려면 캐시 삭제 명령을 실행하고 테스트하는 것이 좋다.
```bash
# 캐시나 버퍼의 내용을 디스크와 동기화
sync
# 운영체제에 포함된 캐시의 내용을 초기화
echo 3 > /proc/sys/vm/drop_caches
```
- 운영체제 별로 캐시를 제거하는 명령이나 방법은 다를 수 있다. (여기는 리눅스 기준)

### 11.8.1.2 MySQL 서버의 버퍼 풀 (InnoDB 버퍼 풀과 MyISAM의 키 캐시)
운영체제의 버퍼나 캐시와 마찬가지로 MySQL 서버에서도 데이터 파일의 내용을 페이지 단위로 캐시하는 기능을 제공한다.
> InnoDB 스토리지 엔진이 관리하는 캐시를 버퍼 풀이라고 하며, MyISAM 스토리지 엔진이 관리하는 캐리는 키 캐시라고 한다.

MySQL 서버가 한번 시작되면 InnoDB 버퍼 풀과, MyISAM의 키 캐시의 내용을 강제로 퍼지 할 수 있는 방법이 없다.
→ MySQL 서버에 포함된 키 캐시나 버퍼 풀을 초기화하려면 MySQL 서버를 재시작해야 한다.

InnoDB 버퍼 풀은 MySQL 서버가 종료될 때 자동으로 덤프됐다가 다시 시작될 때 자동으로 적재된다.
→ 해당 과정을 막기위해선 `innodb_buffer_pool_load_at_startup` 시스템 변수를 OFF로 설정한 후 재시작해야한다.
→ 서버가 종료될 때 버퍼 풀의 내용을 덤프하지 않고자 한다면 `innodb_buffer_pool_dump_at_shutdown` 시스템 변수도 OFF로 변경하면 된다.

### 11.8.1.3 독립된 MySQL 서버
MySQL 서버가 기동 중인 장비에 웹 서버나 다른 배치용 프로그램이 실행되고 있다면 테스트하려는 쿼리의 성능이 영향을 받을 수 있다.
→ MySQL 서버뿐 아니라 테스트로 쿼리를 실행하는 클라이언트 프로그램이나 네트워크의 영향 요소도 고려해야 한다.

### 11.8.1.4 쿼리 테스트 횟수
실제 쿼리의 성능 테스트를 MySQL 서버의 상태가 워밍업된 상태에서 진행할지 아니면 콜드 상태에서 진행할지도 고려해야 한다.
> 워밍업 상태: 캐시나 버퍼가 필요한 데이터로 준비된 상태
> 콜드 상태: 캐시나 버퍼가 모두 초기화된 상태

→ 일반적으로 쿼리의 성능 테스트는 워밍업 상태로 전환된 상태를 가정하고 테스트하는 편이다.

운영체제의 캐시나 버퍼 풀, 키 캐시는 그 크기가 제한적이라서 쿼리에서 필요로하는 데이터나 인덱스 페이지보다 크기가 작으면 플러시 작업과 캐시 작업이 반복해서 발생하므로 쿼리를 한 번 실행해서 나온 결과를 신뢰해서는 안된다.
→ 테스트하려는 쿼리를 번갈아 가면서 6~7번 정도 실행한 후, 처음 한두 번의 결과는 버리고 나머지 결과의 평균값을 기준으로 비교하는 것이 좋다.
