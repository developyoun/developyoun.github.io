---
title: 8.5 전문 검색 인덱스

categories:
- real-mysql

tags:
- study
- database

toc: true
toc_sticky: true
toc_label: Contents
---

문서 전체에 대한 분석과 검색을 위한 인덱싱 알고리즘을 **전문 검색(Full Text Search) 인덱스**라고한다.
> 전문 검색 인덱스는 일반화된 기능의 명칭이지 전문 검색 알고리즘의 이름을 지칭하는 것은 아니다.

## 8.5.1 인덱스 알고리즘
전문 검색에서는 문서 본문의 사용자가 검색하게 될 키워드를 분석해 내고, 빠른 검색용으로 사용할 수 있게 키워드로 인덱스를 구축한다.
전문 검색 인덱스는 키워드를 인덱싱하는 기법에 따라 크게 단어의 *어근 분석* 과 *n-gram 분석* 알고리즘으로 구분할 수 있다.

### 8.5.1.1 어근 분석 알고리즘
전문 검색 인덱스는 **불용어(Stop Word) 처리** 와 **어근 분석(Stemming)** 과정을 거쳐서 색인 작업이 수행된다.
- 불용어 처리
	- 불용어 처리는 검색에서 가치가 없는 단어를 모두 필터링해서 제거하는 작업이다.
	- 불용어의 개수는 많지 않기 때문에 알고리즘을 구현한 코드에 모두 상수로 처리해서 사용하는 경우가 많다.
	- 유연성을 위해 불용어 자체를 데이터베이스화해서 사용자가 추가하거나 삭제할 수 있게 처리하는 경우도 있다.
	- 현재 MySQL 서버는 불용어가 소스코드에 정의돼 있지만, 사용자가 별도로 불용어를 정의할 수 있는 기능을 제공한다.
- 어근 분석
	- 어근 분석은 검색어로 선정된 단어의 뿌리인 원형을 찾는 작업이다.
	- 한글이나 일본어의 경우 영와 같이 단어의 변형 자체는 거의 없기 때문에 어근 분석보다는 형태소 분석으로 명사와 조사를 구분하는 기능이 더 중요한 편이다.
	- MySQL 서버에서는 오픈소스 형태소 분석 라이브러리인 MeCab을 플러그인 형태로 사용할 수 있게 지원한다.
		- MeCab은 일본어를 위한 형태소 분석 프로그램이며, 서구권 언어를 위한 형태소 분석기는 MongoDB에서 사용하는 Snowball이라는 오픈소스가 있다.
		- MeCab을 MySQL 서버에 적용하는 방법은 어렵지 않지만 한글에 맞게 완성도를 갖추는 작업은 많은 시간과 노력이 필요하다.  

### 8.5.1.2 n-gram 알고리즘
> 형태소 분석이 문장을 이해하는 알고리즘이라면, n-gram은 단순히 키워드를 검색해내기 위한 인덱싱 알고리즘이라고 할 수 있다.

n-gram이란 본문을 무조건 몇 글자씩 잘라서 인덱싱하는 방법이다. 
→ 이렇게 만들어진 인덱스의 크기는 상당히 큰편이다.
→ 일반적으로 2글자 단위로 키워드를 쪼개서 인덱싱하는 2-gram(=Bi-gram) 방식이 많이 사용된다.

```markdown
# 2-gram 예제
To be or not to be. That is the question
```
- 각 단어는 띄어쓰기와 마침표를 기준으로 분리된다.
- 각 글자가 중첩해서 2글자씩 토큰으로 구분되는 것이다.

| 단어     | bi-gram(2-gram) 토큰 |     |     |     |     |     |     |
| -------- | -------------------- | --- | --- | --- | --- | --- | --- |
| To       | To                   |     |     |     |     |     |     |
| be       | be                   |     |     |     |     |     |     |
| or       | or                   |     |     |     |     |     |     |
| not      | no                   | ot  |     |     |     |     |     |
| to       | to                   |     |     |     |     |     |     |
| be       | be                   |     |     |     |     |     |     |
| That     | Th                   | ha  | at  |     |     |     |     |
| is       | is                   |     |     |     |     |     |     |
| the      | th                   | he  |     |     |     |     |     |
| question | qu                   | ue  | es  | st  | ti  | io  | on  | 

MySQL 서버는 이렇게 생성된 토큰들에 대해 불용어를 걸러내는 작업을 수행한다.
→ 이때 불용어와 동일하거나 불용어를 포함하는 경우 걸러서 버린다.
→ 불용어는 `information_schema.innodb_ft_defaults_stopword` 테이블을 통해 확인할 수 있다.
→ MySQL 서버는 이렇게 구분된 토큰을 단순한 B-Tree인덱스에 저장한다.

### 8.5.1.3 불용어 변경 및 삭제
실제로 MySQL 서버에 내장된 불용어들을 가지고 처리하는 것은 더 혼란스럽게 할 수 있다. 그래서 불용어 처리 자체를 완전히 무시하거나 MySQL 서버에 내장된 불용어 대신 사용자가 직접 불용어를 등록하는 방법을 권장한다.

**전문 검색 인덱스 불용어 처리 무시**
1.스토리지 엔진에 관계없이 MySQL 서버의 모든 전문 검색 인덱스에 대해 불용어를 완전히 제거하는 방법
→ MySQL 서버의 설정 파일(my.cnf)의 `ft_stopword_file` 시스템 변수에 빈 문자열을 설정하면 된다.
→ 만약 설정을 변경하면 MySQL 서버를 재시작해야만 변경사항이 반영된다.
```json
ft_stopword_file=''
```
→ `ft_stopword_file` 시스템 변수는 사용자 정의 불용어를 적용할 때도 사용할 수 있는데, 직접 정의한 불영어 목록을 저장한 파일의 경로를 `ft_stopword_file` 시스템 변수에 설정하면 된다.

2.InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 인덱스에 대해서만 불용어 처리를 무시하는 방법
→ InnoDB 테이블의 전문 검색 인덱스의 불용어 처리를 무시하려면 `innodb_ft_enable_stopword` 시스템 변수를 OFF로 설정하면 된다.
→ 이 경우, 설정된 스토리지만 불용어 처리를 무시한다.
→ `innodb_ft_enable_stopword` 는 동적인 시스템 변수이므로, MySQL 서버가 실행 중인 상태에서도 변경할 수 있다.

**사용자 정의 불용어 사용**
응용 프로그램의 특성에 맞게 사용자가 직접 정의한 불용어를 사용할 수 있는 방법이 있다.

1.불용어 목록을 파일로 저장하고, MySQL 서버 설정 파일에서 경로를 다음과 같이 `ft_stopword_file` 설정에 등록
```cnf
ft_stopword_file='/data/my_custom_stopword.txt'
```

2.InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 엔진에서만 사용할 수 있는 방법으로, 불용어 목록을 테이블로 저장하는 방법
→ `innodb_ft_server_stopword_table` 시스템 변수에 불용어 테이블을 설정한다.
```sql
CREATE TABLE my_stopword(value VARCHAR(30)) ENGINE = INNODB;
INSERT INTO my_stopword(value) VALUES ('MySQL');

SET GLOBAL innodb_ft_server_stopword_table='mydb_my_stopword';
ALTER TABLE tb_bi_gram ADD FULLTEXT INDEX fx_title_body(title, body) WITH PARSER ngram;
```
→ 이떄 불용어 목록을 변경한 이후, 전문 검색 인덱스가 변경된 불용어가 적용된다는 점에 주의하자.
→ `innodb_ft_user_stopword_table` 시스템 변수를 이용하는 방법도 있다. (기존 방법과 동일)
→ 여러 전문 검색 인덱스가 서로 다른 불용어를 사용해야하는 경우라면 `innodb_ft_user_stopword_table` 을 이용하자

## 8.5.2 전문 검색 인덱스의 가용성
전문 검색 인덱스를 사용하려면 다음 두 가지 조건을 갖춰야 한다.
- 쿼리 문장이 전문 검색을 위한 문법(MATCH … AGAINST …) 을 사용
- 테이블이 전문 검색 대상 컬럼에 대해서 전문 인덱스 보유
```sql
SELECT * FROM tb_test
WHERE MATCH(doc_body) AGAINST('애플' IN BOOLEAN MODE);
```
→ 전문 검색 인덱스를 구성하는 컬럼들은 MATCH 절의 괄호안에 모두 명시되어야 한다.

```sql
SELECT * FROM tb_test WHERE doc_body LIKE '%애플%'
```
→ 이 같은 경우에는 테이블을 처음부터 끝까지 읽는 풀 테이블 스캔으로 쿼리를 처리한다.