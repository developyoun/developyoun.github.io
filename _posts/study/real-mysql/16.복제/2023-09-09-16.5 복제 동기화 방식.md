---
title: 16.5 복제 동기화 방식

categories:
- real-mysql

tags:
- study
- database

toc: true
toc_sticky: true
toc_label: Contents
---

MySQL에서는 소스 서버와 레플리카 서버 간의 복제 동기화 방식을 두 가지 제공한다.
- 비동기 복제 방식 (Asynchronous replication)
- 반동기 복제 (Semi-synchronous replication)

## 16.5.1 비동기 복제
> MySQL의 복제는 기본적으로 비동기 방식으로 동작한다.

비동기 방식이란, 소스 서버가 복제 연결된 레플리카 서버에서 변경 이벤트가 정상적으로 전달되어 적용됐는지 확인하지 않는 방식  
→ 소스 서버에서 커밋된 트랜잭션은 바이너리 로그에 기록  
→ 레플리카 서버는 주기적으로 신규 트랜잭션에 바이너리 로그를 소스 서버에 요청

비동기 복제 방식에서는 소스 서버가 레플리카 서버로 변경 이벤트가 잘 전달됐는지 알지 못한다. (보장되지 않음)  
→ 이에, 소스 서버에 장애가 발생하면 소스 서버에서 최근까지 적용된 트랜잭션이 레플리카 서버로 전송되지 않을 수 있음

비동기 복제는 소스 서버와 레플리카 서버와의 동기화 여부를 보장하지 않는 것이 가장 큰 단점이다.  
하지만, 단점으로 인한 빠른 트랜잭션 처리로 성능이 좋고 레플리카 서버에 문제가 생겨도 소스 서버엔 영향을 받지 않는 것이 장점이다.  
또한, 여러 레플리카를 사용한다고 하더라도 소스 서버엔 큰 성능저하가 없다.  
→ 즉, 레플리카 서버를 확장해서 읽기 트래픽을 분산하는 용도로 제격이다.

## 16.5.2 반동기 복제
반동기 복제 방식은 좀 더 향상된 데이터 무결성을 제공하는 복제 동기화 방식 (비동기 복제 방식보다)  
→ 소스 서버는 레플리카 서버가 소스 서버로부터 전달받은 변경 이벤트를 릴레이 로그에 기록 후 응답 전송(ACK)  
→ 응답을 받은 소스 서버가 트랙잭션을 완전히 커밋시키고 클라이언트에 결과를 반환

여기서 중요한 부분은, 레플리카 서버에 **전송**됐음을 보장하는 것이지, 실제로 복제된 트랜잭션이 레플리카 서버에 **적용**됐다는 것까지 보장하는 것은 아니다.  
→ 그래서 이름이 비동기 복제인 것이다.

반동기 복제는 소스 서버가 트랜잭션 처리 중 어느 지점에서 레플리카 서버의 응답을 기다리냐에 따라 장애 상황에 사용자가 겪을 수 있는 문제가 다를 수 있다.  
→ 사용자는 `rpl_semi_sync_master_wait_point` 시스템 변수를 통해 소스 서버가 레플리카 서버의 응답을 기다리는 지점을 제어할 수 있다.  
→ 시스템 변수에는 `AFTER_SYNC` 또는 `AFTER_COMMIT` 값으로 설정 가능하다.
- **AFTER_SYNC**
    - 소스 서버에서는 각 트랜잭션을 바이너리 로그에 기록
    - 이후에 스토리지 엔진에 커밋하기 전 단계에서 레플리카 서버의 응답을 기다림
    - 레플리카 서버로부터 정상적인 응답을 오면, 소스 서버는 스토리지 엔진을 커밋해서 트랜잭션을 마무리
    - 처리 결과를 클라이언트에 반환
- **AFTER_COMMIT**
    - 소스 서버에서 트랜잭션을 바이너리 로그에 기록
    - 스토리지 엔진에서의 커밋도 진행
    - 클라이언트에 결과를 반환하기 전에 레플리카 서버의 응답을 기다림
    - 레플리카 서버로 부터 응답이 오면, 클라이언트는 처리 결과를 받는다.

> 처음 반동기 복제가 도입되었을 떄는 AFTER_COMMIT 방식으로만 동작했으나, 5.7 이후 AFTER_SYNC 방식이 도입되면서 8.0 버전부터는 기본으로 설정된 동작 방식은 AFTER_SYNC 이다.

`AFTER_SYNC` 방식이 `AFTER_COMMIT` 방식과 비교해서 다음과 같은 장점이 있다.
- 소스 서버에 장애가 발생했을 때 팬텀 리드가 발생하지 않음
- 장애가 발생한 소스 서버에 대해 좀 더 수월한 복구 처리

`AFTER_COMMIT` 에서는 트랜잭션이 스토리지 엔진 커밋까지 처리된 후 레플리카 서버의 응답을 기다리는데, 스토리지 엔진 커밋까지 완료된 데이터는 다른 세션에서도 조회가 가능하다.  
→ 이로 인해 소스 서버가 레플리카 서버로부터 아직 응답을 기다리고 있는 상황에서 장애가 발생한 경우, 사용자는 승격된 레플리카 서버에서 데이터를 조회할 때 이전 소스 서버에서 조회했던 데이터를 보지 못할 수 있다.  
→ 이와 같은 현상을 **팬덤 리드(Phantom Read)** 라고 한다.

`AFTER_SYNC` 에서는 스토리지 엔진 커밋 전에 레플리카 서버의 응답을 기다리므로, 응답을 기다리던 중에 소스 서버에서 장애가 발생하더라도 사용자는 팬텀 리드 현상을 겪지 않게 된다.  
→ 또한 소스 서버에서는 커밋됐으나 레플리카 서버로 복제 되지 않은 상황에서 장애가 발생한 소스 서버를 재사용하는 경우, 트랜잭션을 롤백할 필요가 없다

반동기 복제는 트랜잭션을 처리하는 중에 레플리카 서버의 응답을 기다리므로 비동기 방식과 비교했을 때 트랜잭션의 처리 속도가 좀 더 느릴 수 있다.  
→ 네트워크로 통신하는 부분으로 인해 반동기 복제는 물리적으로 가깝게 위치한 레플리카 서버와의 복제에 더 적합하다고 할 수 있다.

소스 서버에서 레플리카 서버의 응답을 무기한 기다리는 것은 아니고, 타임아웃 시간을 설정할 수 있다.  
→ 소스 서버는 지정된 타임아웃 시간 동안 **레플리카 서버의 응답이 없으면 자동으로 비동기 복제 방식으로 전환한다.**  
→ 또한, 여러 대의 레플리카 서버가 복제 연결되어 있을 때, 전체 레플리카 서버의 응답을 기다려야하는 것은 아니고, 이 또한 레플리카 서버 수를 설정 가능하다

### 16.5.2.1 반동기 복제 설정 방법
> MySQL 서버에서 반동기 복제 기능은 플러그인 형태로 구현되어 있어서 사용하려면 플러그인이 설치되어야 한다.  
> 플러그인은 현재 구동 중인 MySQL 서버에서 동적으로 설치 가능하다.

```sql
-- 소스 서버
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';

-- 레플리카 서버
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
```
- 플러그인이 정상적으로 설치됐는지는 information_schema.PLUGINS 테이블을 조회하거나 `SHOW PLUGINS` 명령으로 확인할 수 있다.

플러그인이 설치되었다고 자동으로 반동기 복제가 활성화되는 것은 아니고, 관련 시스템 변수들을 적절히 설정해야 한다.  
→ 시스템 변수는 플러그인이 정상적으로 설치된 이후에 `SHOW GLOBAL VARIABLES` 명령 등에서 확인할 수 있다.
- rpl_semi_sync_master_enabled
    - 소스 서버에서 반동기 본제의 활성화 여부를 제어한다. ON / OFF로 설정 가능
- rpl_semi_sync_master_timeout
    - 소스 서버에서 레플리카 서버의 응답이 올 때까지 대기 하는 시간 (밀리초 단위로 설정)
    - 해당 변수에 설정된 시간만큼 레플리카 서버의 응답을 기다렸다가 반동기에서 비동기 복제로 전환된다.
    - 기본값은 10000(10초) 이다
- rpl_semi_sync_master_trace_level
    - 소스 서버에서 반동기 복제에 대해 디버깅을 어느 수준으로 로그가 출력되게 할 것인지 설정하는 변수
    - 1, 16, 32, 64 값으로 설정할 수 있다.
- rpl_semi_sync_master_wait_for_slave_count
    - 소스 서버에서 반드시 응답을 받아야 하는 레플리카 수를 결정하는 변수
    - 기본값은 1이며, 최대 65535까지 설정 가능하다.
    - 응답을 받아야 하는 레플리카 수가 많을수록 소스 서버에서의 처리 성능은 저하될 수 있다.
- rpl_semi_sync_master_wait_no_slave
    - rpl_semi_sync_master_timeout 변수에 지정된 시간 동안 소스 서버에서 반동기 복제로 연결된 레플리카 서버 수가 rpl_semi_sync_master_wait_for_slave_count에 지정된 수보다 적어졌을 때 어떻게 처리할지 결정하는 변수
    - ON이면 레플리카 수가 적어지더라도 타임아웃 시간 동안 반동기 복제를 그대로 유지한다. (기본값)
    - OFF이면 레플리카 수가 적어지는 즉시 비동기 복제로 전환된다.
- rpl_semi_sync_master_wait_point
    - 소스 서버가 트랜잭션 처리 단계 중 레플리카 서버의 응답을 대기하는 지점을 설정하는 변수
    - AFTER_SYNC와 AFTER_COMMIT 값으로 설정 가능
- rpl_semi_sync_slave_enabled
    - 레플리카 서버에서 반동기 복제의 활성화 여부를 제어하는 변수
    - ON / OFF 로 설정 가능하다.
- rpl_semi_sync_slave_trace_lavel
    - 레플리카 서버에서 반동기 복제에 대해 어느정도 수준까지 디버깅 로그를 출력되게 할지 설정하는 변수
    - 1, 16, 32, 64 값으로 설정 가능

> 만약 소스 서버와 레플리카 서버가 기존에 복제가 실행 중인 상태라면 반동기 복제 적용을 위해 레플리카 서버에서 레플리케이션 I/O 스레드를 재시작해야한다.
