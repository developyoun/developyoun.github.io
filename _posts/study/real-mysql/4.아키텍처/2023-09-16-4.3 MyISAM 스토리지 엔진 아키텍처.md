---
title: 4.3 MyISAM 스토리지 엔진 아키텍처

categories:
- real-mysql

tags:
- database
- study

toc: true
toc_sticky: true
toc_label: Contents
---

### 4.3.1 키 캐시

InnoDB의 버퍼 풀과 비슷한 역할을 하는 것이 MyISAM의 키 캐시(Key cache, 키 버퍼라도고 불림)이다.MyISAM 키 캐시는 인덱스만을 대상으로 작동하며, 인덱스의 디스크 쓰기 작업에 대해서만 부분적으로 버퍼링 역할을 한다.

```
키 캐시 히트율(Hit rate) = 100 - (key_reads / key_read_requests * 100)
```

> key\_reads: 인덱스를 디스크에서 읽어 들인 횟수를 저장하는 상태 변수\
> key\_reads\_requests: 키 캐시로부터 인덱스를 읽은 횟수를 저장하는 상태 변수\
> 이 상태값들을 확인하려면 `SHOW GLOBAL STATUS` 명령을 사용하면 된다.

\
일반적으로 키 캐시를 이용한 쿼리의 비율(히트율)을 99% 이상으로 유지하라고 권장한다.

* 만약 히트율이 99% 미만이라면 키 캐시를 조금 더 크게 설정하는 것이 좋다.
* 32비트 운영체제에서는 하나의 키 캐시에 4GB 이상의 메모리 공간을 설정할 수 없다.
* 64비트 운영체제에서는 `OS_PER_PROCESS_LIMIT`⁠ 값에 설정된 크기만큼의 메모리를 할당할 수 있다.
* 제한 값 이상의 키 캐시를 할당하고 싶다면 기본 키 캐시 이외의 별도의 명명된 키 캐시 공간을 설정해야 한다.
    * 기본 키 캐시 공간을 설정하는 파라미터는 `key_buffer_size`⁠ 이다.

```
key_buffer_size = 4GB # 기본 키 캐시 4GB 설정
kbuf_board.key_buffer_size = 2GB # kbuf_board라는 이름의 키 캐시 2GB 설정
kbuf_comment.key_buffer_size = 2GB # kbuf_comment라는 이름의 키 캐시 2GB 설정
```

기본이 아닌 명명된 추가 키 캐시는 어떤 인덱스를 캐시할지 MySQL에 알려줘야 한다.

```
CACHE INDEX db1.board, db2.board IN kbuf_board;
CACHE INDEX db1.comment, db2.comment IN kbuf_comment;
```

위와 같이 설정하면, board 테이블의 인덱스는 `kbuf_board` 키 캐시를, comment 테이블의 인덱스는 `kbuf_comment` 키 캐시를 사용할 수 있다.\\

### 4.3.2 운영체제의 캐시 및 버퍼

MyISAM 테이블의 인덱스는 키 캐시를 이용해 디스크를 검색하지 않고도 충분히 빠르게 검색할 수 있다.→ 하지만, MyISAM 테이블의 데이터에 대해서는 디스크로부터의 I/O를 해결해 줄 만한 어떠한 캐시나 버퍼링 기능도 MyISAM 시토리지 엔진은 가지고 있지 않다.\
→ 그래서 해당 테이블의 데이터 읽기나 쓰기 작업은 항상 운영체제의 디스크 읽기 또는 쓰기 작업으로 요청될 수 밖에 없다.\
\
운영체제의 캐시 공간은 남는 메모리를 사용하는 것이 기본 원칙이다.→ 전체 메모리가 8GB인데 MySQL이나 다른 어플리케이션에서 메모리를 모두 사용해 버린다면 운영체제가 캐시 용도로 사용할 수 있는 메모리 공간이 없어진다.\
→ 이럴 경우, MyISAM 테이블 데이터를 캐시하지 못하며, 결국 쿼리 처리가 느려진다.\
→ 운영체제가 사용할 수 있는 캐시 공간을 위해 충분한 메모리를 비워둬야 이런 문제를 방지할 수 있다.\
\
MyISAM이 주로 사용되는 MySQL에서 일반적으로 키 캐시는 최대 물리 메모리의 40% 이상을 넘지 않도록 설정하고, 나머지 메모리 공간은 운영체제가 자체적인 파일 시스템을 위한 캐시 공간을 마련할 수 있도록 하는 것이 좋다.\\

### 4.3.3 데이터 파일과 프라이머리 키(인덱스) 구조

InnoDB 스토리지 엔진을 사용하는 테이블은 프라이머리 키에 의해서 클러스터링되어 저장되는 반면, MyISAM 테이블은 프라이머리 키에 의한 클러스터링 없이 데이터 파일이 힙 공간처럼 활용된다.→ 즉, MyISAM 테이블에 레코드는 프라이머리 키 값과 무관하게 `INSERT`⁠ 되는 순서대로 데이터 파일에 저장된다.\
→ MyISAM 테이블에 저장되는 레코드는 모두 ROWID라는 물리적인 주솟값을 가지는데, 프라이머리 키와 세컨더리 인덱스는 모두 데이터 파일에 저장된 레코드의 ROWID값을 포인터로 가진다.

* 고정 길이 ROWID
    * MyISAM 테이블을 생성 할 때 `MAX_ROWS` 옵션을 명시하면, MySQL 서버는 최대로 가질 수 있는 레코드가 한정된 테이블을 생성한다.
    * `MAX_ROWS` 옵션에 의해 MyISAM 테이블이 가질 수 있는 레코드의 개수가 한정되는 MyISAM 테이블은 ROWID 값으로 4바이트 정수를 사용한다.
    * 이때, 레코드가 INSERT된 순번이 ROWID로 사용된다.
* 가변 길이 ROWID
    * MyISAM 테이블을 생성할 때 MAX\_ROWS 옵션을 설정하지 않으면, ROWID는 최대 `myisam_data_pointer_size` 시스템 변수에 설정된 바이트 수만큼의 공간을 사용할 수 있다.
    * `myisam_data_pointer_size` 시스템 변수의 기본값은 7이므로 ROWID는 2바이트부터 7바이트까지 가변적인 값을 갖게된다.
        * 첫 번째 바이트는 ROWID의 길이를 저장하는 용도로 사용하고 나머지 공간은 실제 ROWID를 저장하는데 사용한다.