---
title: 7.4 언두로그 및 리두 로그 암호화

categories:
- study

tags:
- database

toc: true
toc_sticky: true
toc_label: Contents
---

테이블의 암호화를 적용하더라도 디스크로 저장되는 데이터만 암호화되고 MySQL 서버의 메모리에 존재하는 데이터는 복호화된 평문으로 관리되며, 이 평문 데이터가 테이블의 데이터 파일 이외의 디스크 파일로 기록되는 경우에는 여전히 평문으로 저장된다.
→ 그래서 테이블 암호화를 적용해도, 리두 로그나 언두 로그, 복제를 위한 바이너리 로그에는 평문으로 저장되는 것이다.

MySQL 8.0.16 버전부터는 `innodb_undo_log_encrypt` 시스템 변수로 `innodb_redo_log_encrypt` 시스템 변수를 이용해 InnoDB 스토리지 엔진의 리두 로그와 언두 로그를 암호화된 상태로 저장할 수 있게 개선되었다.
→ 테이블 암호화는 일단 테이블 하나에 대해 암호화가 적용되면 해당 테이블의 모든 데이터가 암호화돼야 하는데, 리두 로그나 언두 로그는 그렇게 적용할 수 없다.
→ 즉, 실행 중인 MySQL 서버에서 언두 로그나 리두 로그를 활성화한다고 하더라도 모든 리두 로그나 언두 로그의 데이터를 해당 시점에 한 번에 암호화해서 다시 저장할 수 없다.
→ 그래서, MySQL 서버는 리두 로그나 언두 로그를 평문으로 저장하다가 암호화가 활성화되면 **그때부터 생성되는 리두 로그나 언두 로그만 암호화해서 저장한다.**
→ 반대로, 리두 로그와 언두 로그가 암호화되는 상태에서 암호화를 비활성화면 **그때부터 저장되는 로그만 평문으로 저장한다.**
> 리두 로그와 언두 로그는 암호화를 활성화했다가 비활성화한다고 해서 즉시 암호화에 사용되는 키가 불필요해지는 것이 아니기 때문에 해당 키는 최대 몇 달 동안 가지고 있어야 할 수도 있다.

`ALTER INSTANCE ROTATE INNODB MASTER KEY` 명령이 실행되면 새로운 마스터 키가 발급되고 테이블 암호화에 사용된 테이블스페이스 키와 동일하게 그 새로운 마스터 키에 의해 다시 암호화 된다.
→ 즉, 리두 로그와 언두 로그를 위한 각각의 프라이빗 키가 발급되고, 해당 프라이빗 키는 마스터 키로 암호화되어 리두 로그 파일과 언두 로그 파일의 헤더에 저장되는 것이다.
```sql
-- InnoDB 리두 로그가 암호화됐는지 조회
SHOW GLOBAL VARIABLES LIKE 'innodb_redo_log_encrypt';
```
| Variable_name           | Value |
| ----------------------- | ----- |
| innodb_redo_log_encrypt | OFF   |

#DB 