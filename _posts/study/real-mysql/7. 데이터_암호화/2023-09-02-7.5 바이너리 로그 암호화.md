---
title: 7.5 바이너리 로그 암호화

categories:
- study

tags:
- database

toc: true
toc_sticky: true
toc_label: Contents
---

테이블 암호화가 적용돼도 바이너리 로그와 릴레이 로그 또한 리두 로그나 언두 로그처럼 평문을 저장한다.
그러나 바이너리 로그는 의도적으로 상당히 긴 시간동안 보관하는 서비스도 있고, 때로는 증분 백업(Incremental Backup)을 위해 바이너리 로그를 보관하기도 한다.
→ 그래서 때로는 바이너리 로그 파일의 암호화는 상황에 따라 중요도가 높아질 수도 있다.

바이너리 로그와 릴레이 로그 파일 암호화 기능은 **디스크에 저장된 로그 파일에 대한 암호화만 담당**하고,
MySQL 서버의 메모리 내부 또는 소스 서버와 레플리카 서버 간의 네트워크 구간에서 로그 데이터를 암호화하지는 않기에, 복제 멤버 간의 네트워크 구간에서도 바이너리 로그를 암호화하고자 한다면 **MySQL 복제를 위한 계정이 SSL**을 사용하도록 설정하면 된다.

## 7.5.1 바이너리 로그 암호화 키 관리
바이너리 로그와 릴레이 로그 파일 데이터의 암호화를 위해서는 **2단계 암호화 키 관리 방식**을 사용한다.
1. 바이너리 로그와 릴레이 로그 파일의 데이터는 파일 키(File Key)로 암호화해서 디스크 저장
2. 파일 키는 "바이너리 로그 암호화 키"로 암호화해서 각 바이너리 로그와 릴레이 로그 파일의 헤더에 저장
→ 즉, "바이너리 로그 암호화 키"는 테이블 암호화의 마스터 키와 동일한 역할을 하며
→ 파일 키는 바이너리 로그와 릴레이 로그 파일 단위로 자동으로 생성되어 해당 로그 파일의 데이터 암호화에만 사용된다.

## 7.5.2 바이너리 로그 암호화 키 변경
바이너리 로그 암호화 키는 다음과 같이 변경(로테이션) 할 수 있다.
```sql
ALTER INSTANCE ROTATE BINLOG MASTER KEY;
```
그리고 바이너리 로그 암호화 키가 변경되면 다음의 과정을 거친다.
1. 증가된 시퀀스 번호화 함께 새로운 바이너리 로그 암호화 키 발급 후 키링 파일에 저장
2. 바이너리 로그 파일과 릴레이 로그 파일 스위치 (새로운 로그 파일로 로테이션)
3. 새로 생성되는 바이너리 로그와 릴레이 로그 파일의 암호화를 위해 파일 키를 생성하고, 파일 키는 바이너리 로그 파일 키(마스터 키)로 암호화해서 각 로그 파일에 저장
4. 기존 바이너리 로그와 릴레이 로그 파일의 파일 키를 읽어서 새로운 바이너리 로그 파일 키로 암호화해서 다시 저장 (암호화되지 않은 로그 파일은 무시)
5. 모든 바이너리 로그와 릴레이 로그 파일이 새로운 바이너리 로그 암호화 키로 다시 암호화됐다면 기존 바이너리 로그 암호화 키를 키링 파일에서 제거
> 위 절차에서 4번 과정은 상당히 시간이 걸리는 작업일 수 있는데, 이를 위해 키링 파일에서 "바이너리 로그 암호화 키"는 내부적으로 버전(시퀀스) 관리가 이뤄진다.

MySQL 서버의 바이너리 로그 파일이 암호화돼 있는지 여부는 `SHOW BINARY LOGS;` 명령을 통해 확인할 수 있다.
```
SHOW BINARY LOGS;
```
| Log_name         | File_size | Encrypted |
| ---------------- | --------- | --------- |
| mysql-bin.000010 | 2853      | No        |
| mysql-bin.000011 | 1337      | Yes

## 7.5.3 mysqlinlog 도구 활용
MySQL 서버에서는 트랜잭션의 내용을 추적하거나 백업 복구를 위해 암호화된 바이너리 로그를 평문으로 복호화할 일이 자주 발생하는데,
한 번 바이너리 로그 파일이 암호화되면 바이너리 로그 암호화 키가 없으면 복호화 할 수 없다.
→ 그러나, 바이너리 로그 암호화 키는 MySQL 서버만 가지고 있어서 복호화가 불가능하다.
→ `mysqlbinlog` 도구를 이용해 암호화된 바이너리 로그 파일의 내용을 SQL 문장으로 암호화된 바이너리 로그 파일을 직접 열어 볼 수는 없다는 내용을 확인할 수 있다.
```bash
mysqlbinlog -vvv mysql-bin.000011

# --- 결과 ---
...
ERROR: Reading encrypted log files directly is not supported.
...
```

#DB 