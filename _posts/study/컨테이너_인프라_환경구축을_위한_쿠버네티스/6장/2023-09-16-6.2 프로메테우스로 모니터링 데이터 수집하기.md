---
title: 6.2 프로메테우스로 모니터링 데이터 수집하기

categories:
- 쿠버네티스/도커

tags:
- kubenetes
- docker

toc: true
toc_sticky: true
toc_label: Contents
---

프로메테우스는 많은 종류의 오브젝트를 설치한다. 오브젝트를 통해 설치된 요소로 모니터링에 필요한 데이터를 수집하고 저장한다.

* 프로메테우스 서버(prometheus-server)
  * 프로메테우스의 주요 기능을 수행하는 요소로, 3가지 역할을 한다.
    * 노드 익스포터 외 여러 개상에서 공개된 메트릭을 수집해 오는 수집기
    * 수집한 시계열 메트릭 데이터를 저장하는 시계열 데이터베이스
    * 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI
  * 프로메테우스의 수집기는 매우 독특한 방법으로 수집 대상을 찾는데, 서비스 디스커버리라는 방법이다.
* 노드 익프포터(node-exporter)
  * 노드의 시스템 메트릭 정보를 HTTP로 공개하는 역할을 한다.
  * 설치된 노드에서 특정 파일을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후에 노드 익스포터에서 HTTP서버로 공개한다.
  * 공개된 내용을 프로메테우스 서버에서 수집해 가게 된다.
* 쿠버 스테이트 메트릭(kube-state-metrics)
  * API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 한다.
  * 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 손쉽게 획득할 수 있는 것은 쿠버 스테이트 메트릭 덕분이다.
* 얼럿매니저(alertmanager)
  * 프로메테우스에 경보 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공한다.
  * 프로메테우스에 설치하면 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 시스템을 안정적으로 운영할 수 있게 한다.
* 푸시게이트웨이(pushgateway)
  * 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.
  * 일반적으로 짧은 시간 동안 실행되고 종료되는 배치성 프로그램의 메트릭을 저장하거나 외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형대로 제공하는 용도로 사용한다.

**서비스 디스커버리로 수집 대상 가져오기**

프로메테우스는 수집 대상을 자동으로 인식하고 필요한 정보를 수집하는데, 정보를 수집하려면 일반적으로 에이전트를 설정해야 하지만 쿠버네티스는 추가로 입력할 필요 없이 자동으로 메트릭을 수집할 수 있다.

이는 프로메테우스 서버가 수집 대상을 가져오는 방법인 **서비스 디스커버리** 를 사용하기 때문이다.

1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어온다.
2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청한다.
3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집한다.

서비스 디스커버리 방법은 대상에 따라 크게 2가지 경로로 나뉜다.

* 쿠버네티스 API 서버에 직접 연결돼 메트릭을 수집하는 **cAdvisor**
* API 서버가 경로를 알려주어 메트릭을 수집할 수 있는 **에이전트** (보통 익스포터라 명명한다)