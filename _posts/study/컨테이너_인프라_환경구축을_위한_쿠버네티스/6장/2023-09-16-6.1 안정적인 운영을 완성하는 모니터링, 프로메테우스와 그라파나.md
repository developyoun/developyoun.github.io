---
title: 6.1 안정적인 운영을 완성하는 모니터링, 프로메레우스와 그라파나

categories:
- 쿠버네티스/도커

tags:
- kubenetes
- docker

toc: true
toc_sticky: true
toc_label: Contents
---

> 컨테이너 인프라 환경에서 가장 권장하는 모니터링 도구는 프로메테우스와 그라파나입니다.

거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 구조로 되어있다.

컨테이너 인프라 환경에서는 모니터링 데이터를 프로메테우스로 수집하고 수집한 정보를 한 곳에 모아(통합) 그라파나로 시각화 한다.

#### 6.1.1 모니터링 도구 선택하기

하나의 도구로 처리하지 않고, 프로메테우스와 그라파나의 혼합 구조를 사용하는 이유는 2가지가 있다.

1. 비용
  * 모니터링 대상마다 라이센스 관련 비용이 발생한다.
  * 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용이 발생한다.
  * 그래서 비용에 민감한 조직에는 도입하기 어렵다.
2. 보안
  * 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링 한다.
  * 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어렵다.

**데이터 수집과 통합 도구**

* 프로메테우스 (Prometheus)
  * 사운드 클라우드에서 자사 서비스의 모니터링을 위해 개발한 도구
  * 현재는 오픈 소스로 전환돼, CNCF(클라우드 네이티브 컴퓨팅 파운데이션)에서 관리한다. (2018년 8월에 졸업 프로젝트가 되었음)
  * 시계열 데이터베이스를 내장하고 있으며 자체적인 질의 페이지 외에 시각화 기능은 없으나 그라파나와 연계하면 시각화 기능을 제공할 수 있다.
  * 중앙 서버에서 에이전트의 데이터를 수집하는 풀 방식을 사용해, 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집하여 모니터링 가능하다.
  * 에이전트를 통해 내부 메트릭을 외부로 노출하기 때문에 사용자가 수집 대상에 접속할 수만 있다면 개인 컴퓨터에서도 메트릭을 가져올 수 있다. (=모니터링 관련 개발을 하기 편리하다)
  * 일회성으로 모니터링 대상에 대한 세부적인 메트릭도 간단하게 웹 브라우저로 확인할 수 있다.
  * 완전한 오픈 소스 모델을 선택 사용자 층이 넓고 관련 자료가 많으면 각종 대시보드 도구나 메신저 등이 연계를 지원하여 직접 모니터링 시스템을 구축할 때 좋다.
* 데이터독 (Datadog)
  * 모니터링 데이터를 업체에서 관리하는 경우를 서비스형이라 하고, 데이터를 사용자가 직접 관리하는 경우를 설치형이라 하는데, 데이터독은 서비스형 소프트웨어 형태로 제공한다.
  * 웹사이트에서 모니터링 대상을 관리할 수 있고, 쿠버네티스를 비롯해 여러 클라우드 서비스나 어플리케이션과 연결이 쉬우므로 관리 부담이 적다는 장점이 있다.
  * 모니터링 대상마다 요금이 부과하기 때문에 모니터링 대상이 늘면 비용이 커지는 단점이 있다.
* 뉴 렐릭(New Relic)
  * 데이터독과 같은 서비스형 소프트웨어이다.
  * 데이터독과 비교했을 때, 어플리케이션 성능 모니터링에 더 특화돼 있다.
  * 마찬가지로 모니터링 대상이 많을수록 비용이 커진다.
* 인플럭스DB (Influx DB)
  * 2013년 인플럭스데이터에서 개발한 시계열 데이터베이스이다.
  * 오픈 소스로 공개된 무료버전과 클라우드에서 바로 사용할 수 있는 서비스형 소프트웨어, 라이센스를 구매해 설치할 수 있는 엔터프라이즈 버전 3가지가 있다.
  * 무료 버전은 프로메테우스와 유사하지만 인플럭스DB가 쓰기 성능이 더 뛰어나 대량의 이벤트를 모니터링하는 데 좀 더 적합하다.
  * 엔터프라이즈 버전은 프로메테우스에서 부족한 부분인 고가용성을 위한 분산 저장을 좀 더 쉽게 구성할 수 있게 하는 기능을 제공한다.
  * 프로메테우스와 더불어 오픈 소스로 모니터링 플랫폼을 구축하기 좋은 도구이다.
  * 유료 서비스라는 선택지까지 있어 선택의 폭이 조금 더 넓다.
  * 프로메테우스보다 상대적으로 구성이 어렵다는 단점이 있다.

| 구분     | 프로메테우스 | 데이터독 | 뉴 렐릭 | 인플럭스DB   |
| ------ | ------ | ---- | ---- | -------- |
| 가격     | 무료     | 유료   | 유료   | 유/무료     |
| 형태     | 설치형    | 서비스형 | 서비스형 | 서비스형/설치형 |
| 참고 자료  | 매우 많음  | 많음   | 많음   | 많음       |
| 기능 확장성 | 매우 좋음  | 좋음   | 좋음   | 좋음       |

**데이터 시각화 도구**

* 그라파나(Grafana)
  * 그라파나 랩스에서 개발했으며, 특정 소프트웨어에 종속되어 있지 않은 독립적인 시각화 도구이다.
  * 30가지 이상의 다양한 도구 및 데이터베이스들과 연계를 지원한다.
  * 주로 시계열 데이터의 시각화에 많이 쓰지만, 관계형 데이터베이스 데이터를 표 형태로 시각화해 사용할 수도 있다.
  * 플러그인과 사용자들이 만들어 둔 대시보드의 공유가 매우 활발해 필요에 따라 적절히 선택해 사용할 수 있다.
  * 오픈 소스이기에 요구 사항에 맞게 수정이 가능하고 필요에 따라 설치형과 서비스형을 모두 선택할 수 있다.
* 키바나(Kibana)
  * 엘라스틱서치를 개발한 엘라스틱에서 만든 시각화 도구이다.
  * 엘라스틱서치에 적재된 데이터를 시각화하거나 검색하는 데 사용하고, 이러하면 데이터를 분석할 때도 사용한다.
  * 엘라스틱서치의 데이터만을 시각화 할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트라는 도구로 엘라스틱서치에 전달해야 하는 불편함이 있다.
  * 시각화 기능이 매우 강력해서, 시각화를 중점적으로 다루는 경우에 사용하면 좋다.
* 크로노그래프(Chronograf)
  * 인플럭스DB를 개발한 인플럭스데이터에서 만든 시각화 도구.
  * 오픈 소스로 제공돼 사용자의 편의에 맞게 수정할 수 있다.
  * 설치형과 서비스형을 모두 제공해 용도에 따라 선택하면 된다.
  * 키바나와 마찬가지로 자사 제품인 인플럭스DB만을 시각화할 수 있으므로, 다양한 대상을 시각화 할 수 없다.

| 구분     | 그라파나          | 키바나      | 크로노그래프   |
| ------ | ------------- | -------- | -------- |
| 가격     | 유/무료          | 유/무료     | 유/무료     |
| 형태     | 서비스형/설치형      | 서비스형/설치형 | 서비스형/설치형 |
| 시각화 대상 | 다양한 대상 시각화 가능 | 엘라스틱서치   | 인플럭스DB   |
| 정보량    | 많음            | 많음       | 적음       |
| 기능 확장성 | 좋음            | 좋음       | 적음       |

***

#### 6.1.2 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 파드를 관리하며, 파드의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 cAdvisor를 사용한다.

cAdvisor는 구글이 만든 컨테이너 메트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해서 kubelet에 전달한다.

이렇게 전달된 메트릭을 수집하는 곳을 메트릭 서버라고 하며, 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 하는 것을 **리소스 메트릭 파이프라인** 이라고 한다.

하지만 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력되기에, 이 메트릭 데이터를 저장 공간에 따로 저장하는 **완전한 모니터링 파이프라인** 으로 구축하기를 권장한다. 그 설계 방식을 반영한 도구가 프로메테우스이다.