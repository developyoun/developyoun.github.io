---
title: 3.3 쿠버네티스 연결을 담당하는 서비스

categories:
- 쿠버네티스/도커

tags:
- kubenetes
- docker

toc: true
toc_sticky: true
toc_label: Contents
---

> 쿠버네티스에서의 **서비스** 는 우리가 일반적으로 생각하고 있는 웹 서비스나 네트워크 서비스처럼 운영 체제에 속한 서비스 데몬, 개발 중인 서비스가 아니다. 그런데 **쿠버네티스의 서비스는 외부에서 쿠버네티스 클러스터에 접속하는 방법을 서비스라고 한다.**
>
> 서비스를 '소비를 위한 도움을 제공한다'는 관점으로 바라본다면 쿠버네티스가 외부에서 쿠버네티스 클러스터 접속하기 위한 '서비스'를 제공한다고 볼 수 있다.

#### 3.3.1 가장 간단하게 연결하는 노드포트

외부에서 쿠버네티스 클러스터의 내부에 접속하는 가장 쉬운 방법은 노트포트(Node Port) 서비스를 이용하는 것이다.

노트포트 서비스를 설정하면 모든 워커 노드의 특정 포트(노트포트)를 열고 여기로 오는 모든 요청을 노드포트 서비스로 전달함으로서 노드포트 서비스는 해당 업무를 처리할 수 있는 파드로 요청을 전달한다.

서비스는 디플로이먼트 yaml 파일로 설정하여 생성할 수 있다.

```
apiVersion: v1
kind: Service # Service 값으로 설정
metadata:
  name: np-svc
spec:
  selector:
    app: np-pods 
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30000
  type: NodePort
```

이를 통해 서비스를 생성하면 `kubectl get services` 명령으로 생성된 서비스 조회가 가능하다.

![](https://i.imgur.com/NPuQG4K.png)

하지만, 이렇게 오브젝트 스펙 파일로 생성하는 방법 말고도 명령어를 통해 생성할 수도 있다.

```
kubectl expose deployment np-pods --type=NodePort --name=np-svc-v2 --port=80
# 여기서 노드포트 번호는 무작위로 생성됨.
```

서비스를 지우고 싶다면 `kubectl delete services ${서비스명}` 을 사용하면 된다.

![](https://i.imgur.com/zWoYRPD.png)

#### 3.3.2 사용 목적별로 연결하는 인그레스

여러 개의 디플로이먼트가 있을 때 그 수만큼 노드포트 서비스를 구동하려면 **인그레스** 를 사용한다.

> 노드포트 서비스는 포트를 중복 사용할 수 없어서 1개의 노드포트에 1개의 디플로이먼트만 적용된다.

인그레스는 고유한 주소를 제공해 사용 목적에 따라 다른 응답을 제공할 수 있으며 트래픽에 대한 L4/L7 로드밸런서와 보안 인증서를 처리하는 기능을 제공한다.

인그레스를 사용하려면 인그레스 컨트롤러가 필요하다. 인그레스 컨트롤러는 파드와 직접 통신할 수 없어서 노드포트 또는 로드밸런스 서비스와 연동되어야 한다.

#### 3.3.3 클라우드에서 쉽게 구성 가능한 로드밸런서

> 노드포트 및 인그레스를 사용해서 서비스를 구성한 방식은 모두, 워커 노드의 노드포트를 통해 노트포트서비스로 이용하고 이를 다시 쿠버네티스의 파드로 보내는 구조인데 이는 매우 비효율적인 방식이다.

쿠버네티스에서는 로드밸런서(Load Balancer)라는 서비스 타입을 제공해 간단한 구조로 파드를 외부에 노출하고 부하를 분산한다.

하지만, 로드밸런서를 사용하려면 로드밸런서를 이미 구현해 둔 서비스 업체의 도움을 받아 쿠버네티스 클러스터 외부에 구현해야 한다.

#### 3.3.4 온프레미스에서 로드밸런서를 제공하는 MetalLB

온프레미스에서 로드밸런서를 사용하려면 내부에 로드밸런서 서비스를 받아주는 구성이 필요한데, 이를 지원하는 것이 MetalLB이다. 이 MetalLB는 베어메타(bare metal, 운영 체제가 설치되지 않은 하드웨어)로 구성된 쿠버네티스에서도 로드밸런서를 사용할 수 있게 고안된 프로젝트이다.

#### 3.3.5 부하에 따라 자동으로 파드 수를 조절하는 HPA

쿠버네티스는 사용자가 갑자기 늘어, 서비스 불가를 초래하는 경우를 막기위해 부하량에 따라 디플로이먼트의 파드 수를 유동적으로 관리하는 기능을 제공하는 데 이를 **HPA(Horizontal Pod Autoscaler)** 라고 한다.

> 파드의 자원이 어느 정도 사용되었는지 파악해야 할 때, 부하를 파악하는 명령은 top 명령을 이용할 수 있다.
>
> ```
> kubectl top pods
> ```
>
![](https://i.imgur.com/dRkaSUW.png)
>
> 현재 상태에서는 에러가 발생하는 모습을 볼 수 있는데, 이는 HPA가 자원을 요청할 때에 메트릭 서버에서 받아온 계측값을 이용하게 된다. 하지만 지금은 메트릭서버가 없기 떄문에 에러가 나타난 것을 확인한 것이다.
>
> 참고로 마지막 출력인, get services http:heapster에서 heapster는 쿠버네티스 1.13이전에서 사용하던 모니터링 도구인데 1.13버전 부터는 메트릭 서버를 모니터링 도구로 추천하고 있다.
>
> 만약, 메트릭 서버가 존재하여 기존 `kubectl top pods` 명령이 정상적으로 나오면 아래와 같다.
>
![](https://i.imgur.com/wMLsH4J.png)

HPA의 현재 상태를 알고 싶다면 `kubectl get hpa` 명령을 통하면 된다.